<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assembly Workstation</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;700&display=swap');
        body { font-family: 'Roboto', sans-serif; background-color: #0a0f1a; color: #eaeaea; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .main-container { width: 100%; max-width: 900px; background: rgba(10, 20, 40, 0.75); backdrop-filter: blur(10px); border-radius: 15px; border: 1px solid rgba(0, 180, 255, 0.3); padding: 25px; position: relative; }
        
        .header-bar { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0, 180, 255, 0.3); padding-bottom: 15px; margin-bottom: 20px; flex-direction: column; gap: 10px; }
        .user-info strong { font-family: 'Orbitron', sans-serif; color: #00e5ff; }
        .header-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: center; }
        .model-selector select { background: #0a0f1a; color: #00e5ff; border: 1px solid rgba(0,180,255,0.5); padding: 8px; border-radius: 5px; font-size: 14px; max-width: 200px; }
        #part-code-select { display: none; } 
        #btn-logout { background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
        .stat-box { background: rgba(0, 180, 255, 0.05); border: 1px solid rgba(0, 180, 255, 0.2); border-radius: 10px; padding: 15px; text-align: center; }
        .stat-box h3 { font-family: 'Orbitron', sans-serif; font-size: 36px; margin: 5px 0 0 0; color: #fff; }
        #ok-count { color: #2ecc71; } #ng-count { color: #e74c3c; } #rework-count { color: #f39c12; } #total-count { color: #00e5ff; }
        
        /* Rework & Total Box Clickable */
        #box-rework-op { cursor: pointer; transition: 0.2s; border: 1px solid #f39c12; }
        #box-rework-op:hover { background: rgba(243, 156, 18, 0.1); transform: scale(1.05); box-shadow: 0 0 15px rgba(243, 156, 18, 0.5); }
        #box-total-op { cursor: pointer; transition: 0.2s; border: 1px solid #00e5ff; }
        #box-total-op:hover { background: rgba(0, 229, 255, 0.1); transform: scale(1.05); box-shadow: 0 0 15px rgba(0, 229, 255, 0.5); }

        .rack-control { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px; border: 1px dashed rgba(0, 180, 255, 0.3); }
        .rack-side { position: relative; display: flex; flex-direction: column; align-items: center; padding: 15px; border-radius: 10px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; background: rgba(255, 255, 255, 0.03); }
        .rack-side.active { background: rgba(0, 180, 255, 0.15); border-color: #00e5ff; box-shadow: 0 0 15px rgba(0, 229, 255, 0.3); }
        .rack-title { font-size: 18px; font-weight: bold; color: #bbb; margin-bottom: 5px; }
        .rack-counter { font-family: 'Orbitron', sans-serif; font-size: 48px; color: #fff; }
        .rack-limit { font-size: 14px; color: #888; margin-bottom: 10px; }
        .rack-full { color: #2ecc71 !important; text-shadow: 0 0 10px #2ecc71; }
        .rack-total-badge { background: #2c3e50; color: #f39c12; padding: 8px 15px; border-radius: 8px; font-size: 16px; border: 1px solid #f39c12; margin-top: 5px; font-weight: bold; width: 80%; text-align: center; }
        .rack-total-badge span { font-family: 'Orbitron', sans-serif; font-size: 24px; color: #fff; margin-left: 5px; }
        
        .action-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; }
        .btn { font-family: 'Orbitron', sans-serif; font-size: 24px; padding: 30px; border: none; border-radius: 10px; cursor: pointer; color: #fff; }
        .btn-ok { background: linear-gradient(145deg, #27ae60, #2ecc71); }
        .btn-ng { background: linear-gradient(145deg, #c0392b, #e74c3c); }
        .btn-rework { background: linear-gradient(145deg, #d35400, #f39c12); }
        .btn-undo { background: linear-gradient(145deg, #7f8c8d, #95a5a6); font-size: 18px; display: flex; align-items: center; justify-content: center; flex-direction: column;}
        
        .reset-container { margin-top: 20px; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; }
        .btn-reset-day { background: transparent; border: 1px solid #e74c3c; color: #e74c3c; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px; transition: all 0.2s; }
        .btn-reset-day:hover { background: #e74c3c; color: white; }

        /* (V19) ANDON BAR */
        .andon-bar { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 2px dashed #555; }
        .btn-andon { border: 2px solid; background: transparent; color: #fff; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.2s; }
        .andon-machine { border-color: #e74c3c; color: #e74c3c; } .andon-machine:hover { background: #e74c3c; color: white; }
        .andon-material { border-color: #f1c40f; color: #f1c40f; } .andon-material:hover { background: #f1c40f; color: black; }
        .andon-leader { border-color: #3498db; color: #3498db; } .andon-leader:hover { background: #3498db; color: white; }

        /* Modals */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 10; justify-content: center; align-items: center; }
        .modal-content { background: rgba(20, 30, 50, 0.95); border: 1px solid #00e5ff; padding: 30px; width: 500px; text-align: center; border-radius: 15px; max-height: 80vh; overflow-y: auto; }
        .modal-content h2 { font-family: 'Orbitron', sans-serif; margin-top: 0; color: #fff; }
        .reason-btn { display: block; width: 100%; padding: 15px; margin-bottom: 10px; background: rgba(255,255,255,0.1); color: white; border: 1px solid #666; cursor: pointer; font-size: 16px; border-radius: 5px; transition: 0.2s; }
        .reason-btn:hover { background: rgba(255,255,255,0.2); }
        .btn-cancel { background: #555 !important; margin-top: 15px;}
        
        /* (V18) Serial Input */
        .qty-input-group { margin-bottom: 20px; text-align: left; }
        .qty-input-group label { color: #00e5ff; font-size: 16px; margin-bottom: 5px; display: block; font-weight: bold; }
        .qty-input-group input { width: 100%; padding: 12px; background: #0a0f1a; border: 1px solid #00e5ff; color: #fff; border-radius: 5px; box-sizing: border-box; font-size: 20px; text-align: center; font-family: 'Orbitron', sans-serif; }
        .qty-input-group input:focus { border-color: #2ecc71; outline: none; box-shadow: 0 0 10px rgba(46, 204, 113, 0.5); }

        .detail-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .detail-table th, .detail-table td { border-bottom: 1px solid rgba(255,255,255,0.1); padding: 10px; text-align: center; color: #ddd; font-size: 14px; }
        .detail-table th { color: #00e5ff; font-weight: bold; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header-bar">
            <div class="user-info">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: <strong id="user-display">...</strong></div>
            <div class="header-controls">
                <div class="model-selector">
                    <select id="model-select-dropdown">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∏‡πà‡∏ô (Model) --</option>
                        <option value="581D">Assy model 581D</option>
                        <option value="320D">REAR COM LAMP 320D</option>
                    </select>
                </div>
                <div class="model-selector"><select id="part-code-select"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Part Code --</option></select></div>
                <button id="btn-logout">‡∏≠‡∏≠‡∏Å</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-box" id="box-total-op" onclick="showTotalDetail()">
                <p style="color:#00e5ff;">Total (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏î‡∏π‡∏¢‡∏≠‡∏î)</p>
                <h3 id="total-count">0</h3>
            </div>
            <div class="stat-box"><p>OK</p><h3 id="ok-count">0</h3></div>
            <div class="stat-box"><p>NG</p><h3 id="ng-count">0</h3></div>
            <div class="stat-box" id="box-rework-op" onclick="window.location.href='rework_check.html'">
                <p style="color:#f39c12;">Rework (‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ)</p>
                <h3 id="rework-count">0</h3>
            </div>
        </div>

        <div class="rack-control">
            <div class="rack-side active" id="rack-left" onclick="selectSide('L')">
                <div class="rack-title">‚¨ÖÔ∏è ‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢ (Left)</div>
                <div class="rack-counter" id="count-left">0</div>
                <div class="rack-limit">/ 8 ‡∏ä‡∏¥‡πâ‡∏ô</div>
                <div class="rack-total-badge">FULL RACKS: <span id="full-racks-left">0</span></div>
            </div>
            <div class="rack-side" id="rack-right" onclick="selectSide('R')">
                <div class="rack-title">‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤ (Right) ‚û°Ô∏è</div>
                <div class="rack-counter" id="count-right">0</div>
                <div class="rack-limit">/ 8 ‡∏ä‡∏¥‡πâ‡∏ô</div>
                <div class="rack-total-badge">FULL RACKS: <span id="full-racks-right">0</span></div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-ok" id="btn-ok">‚úÖ OK</button>
            <button class="btn btn-ng" id="btn-ng">‚ùå NG</button>
            <button class="btn btn-rework" id="btn-rework">‚ôªÔ∏è REWORK</button>
            <button class="btn btn-undo" id="btn-undo">‚Ü©Ô∏è<br>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>

        <div class="andon-bar">
            <button class="btn-andon andon-machine" onclick="triggerAndon('MACHINE')">üîß ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡πÄ‡∏™‡∏µ‡∏¢</button>
            <button class="btn-andon andon-material" onclick="triggerAndon('MATERIAL')">üì¶ ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏´‡∏°‡∏î</button>
            <button class="btn-andon andon-leader" onclick="triggerAndon('LEADER')">üÜò ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤</button>
        </div>
        
        <div class="reset-container"><button class="btn-reset-day" id="btn-reset-day">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (Start New Day)</button></div>
    </div>

    <div class="modal-overlay" id="reason-modal">
        <div class="modal-content">
            <h2 id="modal-title">‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏</h2>
            <div class="qty-input-group">
                <label>‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô (Serial / Tracking No.):</label>
                <input type="text" id="input-serial" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: A-102" autocomplete="off">
            </div>
            <div id="ng-options" style="display:none;">
                <button class="reason-btn" data-reason="Scratch">‡∏£‡∏≠‡∏¢‡∏Ç‡∏µ‡∏î‡∏Ç‡πà‡∏ß‡∏ô</button><button class="reason-btn" data-reason="Short Shot">‡∏â‡∏µ‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏ï‡πá‡∏°</button><button class="reason-btn" data-reason="Color">‡∏™‡∏µ‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô</button><button class="reason-btn" data-reason="Other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</button>
            </div>
            <div id="rework-options" style="display:none;">
                <button class="reason-btn" data-reason="Flash">‡∏ï‡∏±‡∏î‡∏Ñ‡∏£‡∏µ‡∏ö (Flash)</button><button class="reason-btn" data-reason="Contamination">‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏õ‡∏•‡∏Å‡∏õ‡∏•‡∏≠‡∏°</button><button class="reason-btn" data-reason="Assembly">‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ú‡∏¥‡∏î</button><button class="reason-btn" data-reason="Cleaning">‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î</button>
            </div>
            <button class="btn-cancel reason-btn" id="btn-cancel-modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>

    <div class="modal-overlay" id="total-detail-modal">
        <div class="modal-content" style="width: 700px;">
            <h2 style="color: #00e5ff;">üìä ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
            <table class="detail-table">
                <thead><tr><th style="text-align:left;">MODEL / PART</th><th>‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th><th>OK</th><th>‡πÄ‡∏ï‡πá‡∏° (Racks)</th><th>‡πÄ‡∏®‡∏© (Pcs)</th></tr></thead>
                <tbody id="total-detail-body"></tbody>
            </table>
            <button class="btn-cancel reason-btn" onclick="document.getElementById('total-detail-modal').style.display='none'">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentSide = 'L';
        let lastFullRacks = { L: 0, R: 0 };
        let currentActionType = ''; 
        let currentDetailsData = [];

        const partsDatabase = {
            "581D": [ { code: "10117645", name: "PANEL ASSY FR DOOR TRIM RH (B-CAB)" }, { code: "10117646", name: "PANEL ASSY FR DOOR TRIM LH (B-CAB)" }, { code: "10117647", name: "PANEL ASSY FR DOOR TRIM RH (D-CAB) LOW" }, { code: "10117648", name: "PANEL ASSY FR DOOR TRIM LH (D-CAB) LOW" }, { code: "10117649", name: "PANEL ASSY FR DOOR TRIM RH (D-CAB) HI" }, { code: "10117650", name: "PANEL ASSY FR DOOR TRIM LH (D-CAB) HI" }, { code: "10117651", name: "PANEL ASSY FR DOOR TRIM RH (D-CAB) LOW W/Silencer" }, { code: "10117652", name: "PANEL ASSY FR DOOR TRIM LH (D-CAB) LOW W/Silencer" }, { code: "10117653", name: "PANEL ASSY FR DOOR TRIM RH (D-CAB) HI W/Silencer" }, { code: "10117654", name: "PANEL ASSY FR DOOR TRIM LH (D-CAB) HI W/Silencer" }, { code: "10117655", name: "PANEL ASSY RR DOOR TRIM RH (D-CAB) W/O Silencer" }, { code: "10117656", name: "PANEL ASSY RR DOOR TRIM LH (D-CAB) W/O Silencer" }, { code: "10117657", name: "PANEL ASSY RR DOOR TRIM RH (D-CAB) W/ Silencer" }, { code: "10117658", name: "PANEL ASSY RR DOOR TRIM LH (D-CAB) W/ Silencer" } ],
            "320D": [ { code: "320D-001", name: "REAR LAMP LEFT" }, { code: "320D-002", name: "REAR LAMP RIGHT" }, { code: "320D-003", name: "LENS COVER A" } ]
        };
        const partNames = {};
        Object.values(partsDatabase).flat().forEach(p => partNames[p.code] = p.name);

        const modelSelect = document.getElementById('model-select-dropdown');
        const partCodeSelect = document.getElementById('part-code-select');
        const modal = document.getElementById('reason-modal');
        const modalTitle = document.getElementById('modal-title');
        const ngOptions = document.getElementById('ng-options');
        const reworkOptions = document.getElementById('rework-options');
        const serialInput = document.getElementById('input-serial');

        document.addEventListener('DOMContentLoaded', () => {
            const userJson = localStorage.getItem('assemblyUser');
            if (!localStorage.getItem('assemblyToken') || !userJson) { window.location.href = '/'; } 
            else {
                currentUser = JSON.parse(userJson);
                document.getElementById('user-display').textContent = currentUser.full_name;
                if (currentUser.role === 'admin' || currentUser.role === 'leader') {
                    const backBtn = document.createElement('button'); backBtn.innerHTML = "‚ùÆ ‡∏Å‡∏•‡∏±‡∏ö Admin"; backBtn.style.cssText = "background: #3498db; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-right: 10px;"; backBtn.onclick = () => window.location.href = 'admin.html'; document.querySelector('.header-controls').insertBefore(backBtn, document.getElementById('btn-logout'));
                }
                const savedSide = localStorage.getItem('currentSide'); if(savedSide) currentSide = savedSide;
                fetchStats();
            }
        });
        
        modelSelect.addEventListener('change', () => {
            const selectedModel = modelSelect.value;
            partCodeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Part Code --</option>';
            if (partsDatabase[selectedModel]) {
                partCodeSelect.style.display = 'block';
                partsDatabase[selectedModel].forEach(p => {
                    const option = document.createElement('option'); option.value = p.code; option.textContent = `${p.code} - ${p.name.substring(0, 20)}...`; option.title = p.name; partCodeSelect.appendChild(option);
                });
            } else { partCodeSelect.style.display = 'none'; }
            fetchStats();
        });

        function selectSide(side) { currentSide = side; localStorage.setItem('currentSide', side); fetchStats(); }

        function updateRackUI(data) {
            document.getElementById('rack-left').className = `rack-side ${currentSide === 'L' ? 'active' : ''}`;
            document.getElementById('rack-right').className = `rack-side ${currentSide === 'R' ? 'active' : ''}`;
            if (data) {
                const leftFull = Math.floor(data.okLeft / 8); const leftCurrent = data.okLeft % 8;
                const rightFull = Math.floor(data.okRight / 8); const rightCurrent = data.okRight % 8;
                document.getElementById('count-left').innerText = leftCurrent; document.getElementById('full-racks-left').innerText = leftFull;
                document.getElementById('count-right').innerText = rightCurrent; document.getElementById('full-racks-right').innerText = rightFull;
                if (leftFull > lastFullRacks.L && currentSide === 'L') alert("üéâ ‡πÅ‡∏•‡πá‡∏Ñ‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß! (8 ‡∏ä‡∏¥‡πâ‡∏ô)");
                if (rightFull > lastFullRacks.R && currentSide === 'R') alert("üéâ ‡πÅ‡∏•‡πá‡∏Ñ‡∏Ç‡∏ß‡∏≤‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß! (8 ‡∏ä‡∏¥‡πâ‡∏ô)");
                lastFullRacks.L = leftFull; lastFullRacks.R = rightFull;
            }
        }

        // (V18 Updated)
        async function logQcEntry(status, defect = null) {
            const model = modelSelect.value; if (!model) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∏‡πà‡∏ô!"); return; }
            let partCode = null; if (model === '581D') { partCode = partCodeSelect.value; if (!partCode) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Part Code!"); return; } }
            const serialNumber = document.getElementById('input-serial').value || '-';
            const body = { model, part_code: partCode, status, defect, userId: currentUser._id, username: currentUser.username, side: status === 'OK' ? currentSide : null, serial_number: serialNumber };
            try { const res = await fetch('/log-qc', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) }); if (res.ok) { console.log("Saved!"); fetchStats(); } } catch (err) { alert("Error Saving"); }
        }
        
        // Andon Trigger
        async function triggerAndon(type) {
            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ${type}?`)) return;
            try { await fetch('/trigger-andon', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ type, userId: currentUser._id, username: currentUser.username }) }); alert("üö® ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß!"); } catch(e) { alert("Fail"); }
        }

        function showTotalDetail() {
            const tbody = document.getElementById('total-detail-body'); tbody.innerHTML = '';
            if (!currentDetailsData || currentDetailsData.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#888;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>'; } 
            else { currentDetailsData.forEach(item => { let dn = item.part_code || item.model; if(partNames[dn]) dn = `<div>${dn}</div><small style="color:#888">${partNames[dn]}</small>`; tbody.innerHTML += `<tr><td style="text-align:left;">${dn}</td><td>${item.total_inspect}</td><td style="color:#2ecc71;font-weight:bold;">${item.total_ok}</td><td class="col-rack">${item.full_racks}</td><td>${item.pending}</td></tr>`; }); }
            document.getElementById('total-detail-modal').style.display = 'flex';
        }

        // (V18) Reset Input on Open
        document.getElementById('btn-ng').onclick = () => { currentActionType = 'NG'; modalTitle.innerText = "‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢ (NG)"; modalTitle.style.color = "#e74c3c"; ngOptions.style.display = 'block'; reworkOptions.style.display = 'none'; serialInput.value = ''; serialInput.focus(); modal.style.display = 'flex'; };
        document.getElementById('btn-rework').onclick = () => { currentActionType = 'REWORK'; modalTitle.innerText = "‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ã‡πà‡∏≠‡∏°"; modalTitle.style.color = "#f39c12"; ngOptions.style.display = 'none'; reworkOptions.style.display = 'block'; serialInput.value = ''; serialInput.focus(); modal.style.display = 'flex'; };
        
        document.querySelectorAll('.reason-btn').forEach(btn => { btn.onclick = (e) => { if (e.target.id === 'btn-cancel-modal') return; const reason = e.target.dataset.reason; logQcEntry(currentActionType, reason); modal.style.display = 'none'; }; });
        document.getElementById('btn-cancel-modal').onclick = () => modal.style.display = 'none';
        document.getElementById('btn-ok').onclick = () => { document.getElementById('input-serial').value = '-'; logQcEntry('OK'); };

        document.getElementById('btn-undo').addEventListener('click', async () => { if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î?')) return; try { const res = await fetch('/undo-last-qc', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: currentUser._id }) }); if (res.ok) { alert('‚úÖ Undo ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); if (currentSide === 'L') lastFullRacks.L = Math.max(0, lastFullRacks.L - 1); if (currentSide === 'R') lastFullRacks.R = Math.max(0, lastFullRacks.R - 1); fetchStats(); } else { alert('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ'); } } catch (err) { alert("Error"); } });
        document.getElementById('btn-reset-day').addEventListener('click', async () => { if (!confirm('‚ö†Ô∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) return; try { const res = await fetch('/reset-today', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: currentUser._id }) }); if (res.ok) { alert('‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!'); lastFullRacks = { L: 0, R: 0 }; fetchStats(); } } catch (err) { alert("Error"); } });
        
        async function fetchStats() {
            try {
                const selectedModel = modelSelect.value;
                let url = `/get-stats/${currentUser._id}`;
                if(selectedModel) url += `?model=${encodeURIComponent(selectedModel)}`;
                const res = await fetch(url);
                const data = await res.json();
                document.getElementById('ok-count').innerText = data.ok;
                document.getElementById('ng-count').innerText = data.ng;
                document.getElementById('rework-count').innerText = data.rework;
                document.getElementById('total-count').innerText = data.total;
                currentDetailsData = data.details; // Store for modal
                updateRackUI(data);
            } catch (err) {}
        }
        
        modelSelect.addEventListener('change', () => { fetchStats(); });
        document.getElementById('btn-logout').onclick = async () => { if(currentUser && currentUser._id) { try { await fetch('/logout', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: currentUser._id }) }); } catch(e) {} } localStorage.removeItem('assemblyToken'); localStorage.removeItem('assemblyUser'); window.location.href = '/'; };
    </script>
</body>
</html>
